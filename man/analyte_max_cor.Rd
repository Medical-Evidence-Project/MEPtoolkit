% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/analyte_max_cor.R
\name{analyte_max_cor}
\alias{analyte_max_cor}
\title{Maximum plausible pre/post correlation among analytes (rounding-aware)}
\usage{
analyte_max_cor(
  analyte,
  m1,
  s1,
  m2,
  s2,
  k = 1,
  use = c("pre", "post", "average"),
  data = NULL,
  append = FALSE,
  out_cols = c("cvi", "cva", "cvt", "cvw", "cvg", "r_max_analytic", "r_max_total"),
  output = FALSE
)
}
\arguments{
\item{analyte}{Character scalar or column in \code{data}.}

\item{m1, s1, m2, s2}{Character scalars or columns in \code{data} (use strings like \code{"64.3"}).}

\item{k}{Integer (\eqn{\ge} 1). Number of replicates averaged.}

\item{use}{Which cross-sectional CV to use: \code{"pre"}, \code{"post"}, or \code{"average"}.}

\item{data}{Optional data.frame providing columns for analyte, m1, s1, m2, s2.}

\item{append}{Logical. If \code{TRUE} and \code{data} provided, append ceilings as columns.}

\item{out_cols}{Length-7 character vector: names for analytic-only and total ceilings.
Defaults to \code{c("r_max_analytic","r_max_total")}.}

\item{output}{Logical. If \code{TRUE}, also outputs a summary of results in the console.}
}
\value{
\itemize{
  \item Single case (no \code{data}, \code{append = FALSE}): an object of class
        \code{"analyte_max_cor"} with detailed components and a pretty printer.
  \item Multiple cases, \code{append = FALSE}: a data.frame with columns
        \code{case}, \code{analyte}, \code{cvi}, \code{cva}, \code{cvt}, \code{cvw}, \code{cvg},
        \code{r_max_analytic}, \code{r_max_total}. It is tagged so that
        \code{print.analyte_max_cor()} prints a compact table.
  \item Multiple cases, \code{append = TRUE}: the input \code{data} with two new columns
        named by \code{out_cols}.
}
}
\description{
Uses CVA/CVI for the given analyte (from \code{MEPtoolkit::analytes}) and the
study's pre/post mean & SD to compute the pre–post correlation you would expect
if there were no person-to-person heterogeneity in true change; i.e., a
maximum expected correlation (a ceiling).
}
\details{
You can pass a single case (scalars) or a data frame with columns for multiple
cases. For rounding-aware bounds, \strong{m1, s1, m2, s2 must be character strings}
such as \code{"64.3"} and \code{"25.4"} so the number of decimals encodes rounding.


\strong{Goal.} Return the maximum plausible pre–post correlation \eqn{r_{\max}}
for an analyte if everyone changes by the same amount (no between-subject
heterogeneity). This is the single-measurement ICC ceiling implied by assay plus
within-person biology under your study variability.

\strong{Inputs used.}
\itemize{
  \item Loads \code{MEPtoolkit::analytes} and matches \code{analyte}
        (case/space/punctuation-insensitive).
  \item Gets \eqn{CV_A} (analytic) and \eqn{CV_I} (intraindividual) as
        proportions. If \eqn{k} replicates were averaged, uses \eqn{CV_A/\sqrt{k}}.
  \item Forms cross-sectional CVs \eqn{CV_{T,\mathrm{pre}} = s_1/m_1} and
        \eqn{CV_{T,\mathrm{post}} = s_2/m_2}; uses \code{"pre"}, \code{"post"},
        or \code{"average"} per \code{use}.
}

\strong{Computation (additive \%CV algebra).}
\deqn{CV_W^2 = CV_A^2 + CV_I^2,\qquad
      CV_G^2 = \mathrm{max}\bigl(CV_T^2 - CV_W^2,\, 0\bigr).}
\deqn{r_{\max} = \frac{CV_G^2}{CV_G^2 + CV_W^2}, \qquad
      r_{\max}^{(\mathrm{analytic})} = \frac{CV_G^2}{CV_G^2 + CV_A^2}.}

\strong{Rounding model.}
\itemize{
  \item Study inputs: \code{m1}, \code{s1}, \code{m2}, \code{s2} are treated as rounded
        to the provided number of decimals; intervals are constructed accordingly via
        \code{validate_descriptive()}.
  \item Reference table: \code{CVI} is rounded to 3 dp (modeled as \code{cvi - 0.0005} minimum);
        \code{CVA} is derived from QC mean/sd, each rounded to 2 dp, then scaled for
        replicates by \eqn{1/\sqrt{k}}.
  \item The ceiling is maximized by using the largest plausible \eqn{CV_T}
        and the smallest plausible within-person variance.
}

\strong{Assumptions.}
\itemize{
  \item Same measurand/method as the quality control data.
  \item Additive variance algebra on the CV scale:
        \eqn{CV_T^2 \approx CV_G^2 + CV_W^2}.
  \item Prefer \code{use = "pre"} unless variability post-intervention is a pure
        location shift (heterogeneity inflates \eqn{CV_T} at post).
}

\strong{Units.} The calculation uses SD divided by the mean, so any
multiplicative unit change (e.g., mg/dL \eqn{\leftrightarrow} mmol/L) cancels out; you do not
need identical units across sources as long as they are linked by a pure rescale.
Do not mix scales (e.g., mean on raw scale, SD on log scale). For analytes with
affine systems (non-zero intercept) such as HbA1c IFCC vs NGSP, use the matching
row or convert both mean and SD to that system before calling the function; affine
transforms change CVs.

\strong{Edge cases.}
\itemize{
  \item If \eqn{CV_T^2 \le CV_W^2}, set \eqn{CV_G^2 = 0} and return \eqn{r_{\max} = 0}.
  \item If a denominator is numerically zero, return \code{1} for that ratio.
}

\strong{Available analytes.}
The \code{analyte} argument (matching is case/space/punctuation-insensitive)
can be any of the following:
\itemize{
  \item \code{25-hydroxy-Vitamin D}
  \item \code{Alanine Aminotransferase}
  \item \code{Albumin}
  \item \code{Alkaline Phosphatase}
  \item \code{Aspartate Aminotransferase}
  \item \code{Calcium}
  \item \code{Chloride}
  \item \code{Creatinine}
  \item \code{Gamma Glutamyltransferase}
  \item \code{Glucose}
  \item \code{HbA1c Diabetes IFCC}
  \item \code{HbA1c Diabetes NGSP}
  \item \code{HbA1c Healthy IFCC}
  \item \code{HbA1c Healthy NGSP}
  \item \code{HDL Cholesterol}
  \item \code{Hemoglobin}
  \item \code{Holotranscobalamin}
  \item \code{Iron}
  \item \code{Lactate}
  \item \code{Lactate Dehydrogenase}
  \item \code{LDL Cholesterol}
  \item \code{Magnesium}
  \item \code{Osmolality}
  \item \code{PCO2}
  \item \code{Phosphate}
  \item \code{Potassium}
  \item \code{Rheumatoid Factor}
  \item \code{Sodium}
  \item \code{Thyroid Stimulating Hormone}
  \item \code{Total Bilirubin}
  \item \code{Total Cholesterol}
  \item \code{Total Protein}
  \item \code{Total Testosterone}
  \item \code{Transferrin}
  \item \code{Triglycerides}
  \item \code{Urea}
  \item \code{Uric Acid}
  \item \code{Vitamin B12}
}
}
\examples{
analyte_max_cor("25-hydroxy-Vitamin D",
                m1 = "64.3", s1 = "25.4",
                m2 = "88.5", s2 = "23.2",
                k = 1, use = "pre")

df <- data.frame(
  analyte = c("Sodium","Total Cholesterol"),
  m1 = c("140.2","6.60"),
  s1 = c("2.10","0.90"),
  m2 = c("139.8","6.40"),
  s2 = c("2.05","0.90"),
  stringsAsFactors = FALSE
)
analyte_max_cor(analyte = analyte, m1 = m1, s1 = s1, m2 = m2, s2 = s2,
                k = 1, use = "pre", data = df, append = TRUE)

}
